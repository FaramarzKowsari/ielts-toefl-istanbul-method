import React, { useState, useEffect, useCallback } from 'react';
import { 
  BookOpen, 
  ExternalLink, 
  Award, 
  PlayCircle,
  Square,
  Headphones,
  CheckCircle2,
  BookMarked,
  MessageSquare,
  PenTool
} from 'lucide-react';

export default function App() {
  const [playingId, setPlayingId] = useState(null);
  const [voicesLoaded, setVoicesLoaded] = useState(false);
  const [imageError, setImageError] = useState(false);
  const bookLink = "https://play.google.com/store/books/details?id=vUi3EQAAQBAJ";

  // Ensure voices are loaded for Speech Synthesis
  useEffect(() => {
    const handleVoicesChanged = () => {
      setVoicesLoaded(true);
    };
    window.speechSynthesis.onvoiceschanged = handleVoicesChanged;
    // Fallback if voices are already loaded
    if (window.speechSynthesis.getVoices().length > 0) {
      setVoicesLoaded(true);
    }
    return () => {
      window.speechSynthesis.onvoiceschanged = null;
      window.speechSynthesis.cancel(); // Stop playing when component unmounts
    };
  }, []);

  const stopAudio = useCallback(() => {
    window.speechSynthesis.cancel();
    setPlayingId(null);
  }, []);

  const handlePlayAudio = useCallback((id, textToRead) => {
    const synth = window.speechSynthesis;

    // If clicking play on the same item, restart it. If different, stop current.
    synth.cancel(); 

    const utterance = new SpeechSynthesisUtterance(textToRead);
    
    // Try to find the most natural English voice (Prefer Google's premium voices)
    const voices = synth.getVoices();
    
    // 1. Prioritize Google's specific natural voices
    let preferredVoice = voices.find(voice => 
      voice.name.includes('Google') && (voice.lang === 'en-US' || voice.lang === 'en-GB')
    );
    
    // 2. Fallback to any premium/enhanced English voice
    if (!preferredVoice) {
      preferredVoice = voices.find(voice => 
        (voice.lang.includes('en-GB') || voice.lang.includes('en-US')) && 
        (voice.name.includes('Premium') || voice.name.includes('Enhanced'))
      );
    }

    // 3. Fallback to any standard English voice
    if (!preferredVoice) {
      preferredVoice = voices.find(voice => voice.lang.includes('en-GB') || voice.lang.includes('en-US'));
    }
    
    if (preferredVoice) {
      utterance.voice = preferredVoice;
    }
    
    utterance.lang = 'en-US';
    utterance.rate = 0.95; // Slightly slower for clear, natural dictation
    utterance.pitch = 1.0;

    utterance.onend = () => {
      setPlayingId(null);
    };

    utterance.onerror = () => {
      setPlayingId(null);
    };

    setPlayingId(id);
    synth.speak(utterance);
  }, []);

  const bookSections = [
    {
      id: "reading",
      icon: <BookMarked className="w-6 h-6 text-indigo-600" />,
      title: "The Reading Matrix: Navigating the Traps",
      description: "Most students fail the reading section not because of poor vocabulary, but due to poor strategy. The Istanbul Method teaches you how to map the text before reading a single paragraph.",
      example: "Example: In 'True/False/Not Given' questions, the book shows you how to identify 'Absolute Modifiers' (words like always, never, exactly). For instance, if the text says 'Many birds migrate south', and the question asks 'All birds migrate south' (False), versus 'Some birds migrate to Africa' (Not Given). You will learn to spot these psychological traps instantly.",
      fullText: "The Reading Matrix: Navigating the Traps. Most students fail the reading section not because of poor vocabulary, but due to poor strategy. The Istanbul Method teaches you how to map the text before reading a single paragraph. For example, in True, False, Not Given questions, the book shows you how to identify Absolute Modifiers like 'always', 'never', or 'exactly'. If the text says 'Many birds migrate south', and the question asks 'All birds migrate south', the answer is False. But if it asks 'Some birds migrate to Africa', it is Not Given. You will learn to spot these psychological traps instantly."
    },
    {
      id: "listening",
      icon: <Headphones className="w-6 h-6 text-indigo-600" />,
      title: "The Listening Echo: Anticipation Over Reaction",
      description: "Band 9 candidates don't just listen; they anticipate what the speaker is going to say next. This section trains your brain to recognize audio pivot points and structural markers.",
      example: "Example: The book trains you to listen for 'Pivot Words' such as 'However', 'Conversely', or 'Actually'. If a speaker says, 'We originally planned to build the library on the West side...', a Band 9 listener already knows the answer will NOT be the West side, and prepares their pencil for the pivot word that introduces the final location.",
      fullText: "The Listening Echo: Anticipation Over Reaction. Band 9 candidates don't just listen; they anticipate what the speaker is going to say next. This section trains your brain to recognize audio pivot points and structural markers. For example, the book trains you to listen for Pivot Words such as 'However', 'Conversely', or 'Actually'. If a speaker says, 'We originally planned to build the library on the West side', a Band 9 listener already knows the answer will NOT be the West side, and prepares their pencil for the pivot word that introduces the actual, final location."
    },
    {
      id: "writing",
      icon: <PenTool className="w-6 h-6 text-indigo-600" />,
      title: "The Writing Blueprint: Architecting a 9.0 Essay",
      description: "Examiners scan for specific logical structures, not just fancy words. Learn the exact paragraph architectures that force the examiner to award a high score for Coherence and Cohesion.",
      example: "Example: Instead of writing a flat paragraph, you will learn the '4-Step Expansion Model': 1) Topic Sentence (The claim). 2) Clarification (What this means). 3) Concrete Example (A specific, undeniable fact). 4) Conclusive Link (Tying back to the prompt). This structure guarantees a high score even with simple vocabulary.",
      fullText: "The Writing Blueprint: Architecting a 9.0 Essay. Examiners scan for specific logical structures, not just fancy words. Learn the exact paragraph architectures that force the examiner to award a high score for Coherence and Cohesion. For example, instead of writing a flat paragraph, you will learn the 4-Step Expansion Model: Step 1, Topic Sentence. Step 2, Clarification. Step 3, Concrete Example. And Step 4, Conclusive Link. This structure guarantees a high score even with simple vocabulary, because your logic becomes undeniable."
    },
    {
      id: "speaking",
      icon: <MessageSquare className="w-6 h-6 text-indigo-600" />,
      title: "The Speaking Persona: Engineering Fluency",
      description: "Fluency isn't about speaking fast; it's about speaking smoothly and maintaining control. Discover how to use hesitation devices and native-like fillers to buy time and sound authentic.",
      example: "Example: When faced with a difficult Part 3 question, instead of freezing or saying 'Ummm', the Istanbul Method teaches you to use native buffer phrases like: 'That's a rather complex issue, but if I had to pinpoint one main factor...' This buys you 4 seconds of thinking time while demonstrating advanced grammatical control.",
      fullText: "The Speaking Persona: Engineering Fluency. Fluency isn't about speaking fast; it's about speaking smoothly and maintaining control. Discover how to use hesitation devices and native-like fillers to buy time and sound authentic. For example, when faced with a difficult Part 3 question, instead of freezing, the Istanbul Method teaches you to use native buffer phrases like: 'That's a rather complex issue, but if I had to pinpoint one main factor...' This technique buys you crucial seconds of thinking time while demonstrating advanced grammatical control to the examiner."
    }
  ];

  return (
    <div className="min-h-screen bg-slate-50 text-slate-800 font-sans selection:bg-indigo-100 selection:text-indigo-900" dir="ltr">
      
      {/* Navbar */}
      <nav className="sticky top-0 z-50 bg-white/90 backdrop-blur-md shadow-sm border-b border-slate-200 transition-all">
        <div className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center h-16">
            <div className="flex items-center gap-2">
              <BookOpen className="w-6 h-6 text-indigo-600" />
              <span className="font-bold text-lg tracking-tight text-slate-900">The Istanbul Method</span>
            </div>
            <div>
              <a 
                href={bookLink}
                target="_blank"
                rel="noopener noreferrer"
                className="text-sm font-medium text-slate-600 hover:text-indigo-600 transition-colors hidden sm:inline-block mr-2"
              >
                Available on Google Play
              </a>
            </div>
          </div>
        </div>
      </nav>

      {/* SEO Introduction & Hero Section */}
      <header className="relative bg-white overflow-hidden border-b border-slate-200">
        <div className="absolute top-0 left-0 w-full h-full bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-indigo-50 via-white to-white opacity-70"></div>
        
        <div className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10 pt-16 pb-20 flex flex-col lg:flex-row items-center gap-12 text-center lg:text-left">
          
          {/* Text Content */}
          <div className="flex-1">
            <div className="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-indigo-50 border border-indigo-100 text-indigo-700 font-medium text-xs mb-6 uppercase tracking-wider">
              <Award className="w-4 h-4" />
              <span>IELTS & TOEFL Masterclass</span>
            </div>
            
            <h1 className="text-4xl sm:text-5xl lg:text-6xl font-extrabold tracking-tight text-slate-900 mb-6">
              10 Days to a <span className="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-blue-500">Band 9 Mindset</span>
            </h1>
            
            {/* SEO Optimized Paragraph */}
            <p className="text-base sm:text-lg text-slate-600 mb-8 leading-relaxed">
              <strong>The Istanbul Method</strong> by <strong>Faramarz Kowsari</strong> is the ultimate strategic guide for international students aiming to conquer the <strong>IELTS</strong> and <strong>TOEFL</strong> English proficiency exams. Unlike traditional textbooks that focus solely on vocabulary and grammar, this comprehensive masterclass unlocks the psychological strategies, pattern recognition techniques, and structural secrets required to achieve a prestigious <strong>Band 9</strong> in IELTS or a <strong>110+ score</strong> in TOEFL. Master the Reading, Listening, Writing, and Speaking sections in just 10 focused days.
            </p>

            <a 
              href={bookLink}
              target="_blank"
              rel="noopener noreferrer"
              className="inline-flex items-center gap-2 bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors shadow-sm hover:shadow"
            >
              <img 
                src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d0/Google_Play_Books_icon_%282016%29.svg/512px-Google_Play_Books_icon_%282016%29.svg.png" 
                alt="Google Play Books" 
                className="w-5 h-5 bg-white rounded-sm p-0.5" 
              />
              <span>View on Google Play Books</span>
            </a>
          </div>

          {/* Book Cover Image Area */}
          <div className="flex-shrink-0 w-full max-w-sm lg:w-96 perspective-1000">
            <div className="relative mx-auto w-3/4 lg:w-full transform transition-transform duration-500 hover:scale-105 hover:-rotate-1">
              <div className="absolute inset-0 bg-indigo-600 blur-2xl opacity-20 rounded-3xl transform translate-y-6 translate-x-4"></div>
              
              {/* Actual Cover Image with Fallback */}
              <div className="relative z-10 bg-white rounded-r-2xl rounded-l-md shadow-2xl border-l-8 border-indigo-900 overflow-hidden aspect-[2/3] flex items-center justify-center bg-slate-100">
                {!imageError ? (
                  <img 
                    src="cover.jpeg" 
                    alt="The Istanbul Method by Faramarz Kowsari - Official Book Cover" 
                    className="w-full h-full object-cover"
                    onError={() => setImageError(true)}
                  />
                ) : (
                  // Fallback CSS Cover if cover.jpeg is not found
                  <div className="w-full h-full bg-gradient-to-b from-slate-800 to-slate-900 p-6 flex flex-col items-center justify-center text-center">
                    <h2 className="text-2xl font-serif font-bold text-white mb-2">The Istanbul Method</h2>
                    <h3 className="text-sm text-slate-300 tracking-widest uppercase mb-8">For IELTS & TOEFL</h3>
                    <div className="w-full h-px bg-slate-700 mb-8"></div>
                    <p className="text-sm font-bold text-indigo-400 uppercase tracking-widest mb-2">10 Days</p>
                    <p className="text-xs text-slate-400 mb-auto">To a Band 9 Mindset</p>
                    <p className="text-xs font-medium text-slate-500 mt-8 tracking-widest uppercase">Faramarz Kowsari</p>
                  </div>
                )}
                
                {/* Book Binding Highlight Effect */}
                <div className="absolute top-0 left-0 w-4 h-full bg-gradient-to-r from-black/40 to-transparent pointer-events-none"></div>
                <div className="absolute top-0 left-0 w-full h-full bg-gradient-to-tr from-white/10 to-transparent pointer-events-none"></div>
              </div>
            </div>
          </div>

        </div>
      </header>

      {/* Detailed Chapters Section with TTS */}
      <section className="py-24 bg-slate-50">
        <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="text-center mb-16">
            <h2 className="text-3xl font-bold text-slate-900 mb-4">Inside The Book</h2>
            <p className="text-slate-600 max-w-2xl mx-auto">
              Click the play button on any section below to listen to a brief overview and an actionable example from the book. Read naturally using Google's TTS engine.
            </p>
          </div>

          <div className="space-y-8">
            {bookSections.map((section) => (
              <div 
                key={section.id} 
                className={`bg-white rounded-2xl p-6 sm:p-8 shadow-sm border transition-all duration-300 ${
                  playingId === section.id 
                    ? 'border-indigo-400 shadow-md ring-1 ring-indigo-100' 
                    : 'border-slate-200 hover:border-indigo-200 hover:shadow-md'
                }`}
              >
                <div className="flex flex-col sm:flex-row gap-6">
                  {/* Icon & Play/Stop Buttons Area */}
                  <div className="flex-shrink-0 flex flex-col items-center gap-4">
                    <div className="w-14 h-14 rounded-full bg-indigo-50 flex items-center justify-center border border-indigo-100">
                      {section.icon}
                    </div>
                    
                    <div className="flex gap-2">
                      <button
                        onClick={() => handlePlayAudio(section.id, section.fullText)}
                        className={`flex items-center justify-center w-10 h-10 rounded-full transition-all duration-300 ${
                          playingId === section.id 
                            ? 'bg-indigo-100 text-indigo-700' 
                            : 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm'
                        }`}
                        title="Play audio"
                      >
                        <PlayCircle className="w-5 h-5" />
                      </button>

                      <button
                        onClick={stopAudio}
                        disabled={playingId !== section.id}
                        className={`flex items-center justify-center w-10 h-10 rounded-full transition-all duration-300 ${
                          playingId === section.id 
                            ? 'bg-red-100 text-red-600 hover:bg-red-200 shadow-sm' 
                            : 'bg-slate-100 text-slate-400 cursor-not-allowed'
                        }`}
                        title="Stop audio"
                      >
                        <Square className="w-4 h-4 fill-current" />
                      </button>
                    </div>

                    {playingId === section.id && (
                      <span className="text-xs font-medium text-indigo-600 animate-pulse">Playing...</span>
                    )}
                  </div>

                  {/* Content Area */}
                  <div className="flex-1">
                    <h3 className="text-2xl font-bold text-slate-900 mb-3">{section.title}</h3>
                    <p className="text-slate-600 text-base leading-relaxed mb-4">
                      {section.description}
                    </p>
                    <div className="bg-slate-50 rounded-xl p-5 border border-slate-100">
                      <h4 className="flex items-center gap-2 font-semibold text-slate-800 mb-2">
                        <CheckCircle2 className="w-4 h-4 text-emerald-500" />
                        Practical Application
                      </h4>
                      <p className="text-slate-600 text-sm leading-relaxed italic">
                        "{section.example}"
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>

      {/* Footer */}
      <footer className="bg-slate-900 py-12 border-t border-slate-800">
        <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col items-center text-center">
          <h3 className="text-xl font-bold text-white mb-4">Ready to upgrade your exam strategy?</h3>
          <p className="text-slate-400 mb-8 max-w-md">
            Get instant access to the digital edition and start reading on your phone, tablet, or computer.
          </p>
          
          <a 
            href={bookLink}
            target="_blank"
            rel="noopener noreferrer"
            className="inline-flex items-center gap-2 text-slate-300 hover:text-white transition-colors mb-12"
          >
            <span>View on Google Play Books</span>
            <ExternalLink className="w-4 h-4 ml-1" />
          </a>

          <div className="text-slate-500 text-sm w-full pt-8 border-t border-slate-800 flex flex-col sm:flex-row justify-between items-center gap-4">
            <div className="flex items-center gap-2">
              <BookOpen className="w-4 h-4" />
              <span>The Istanbul Method Â© {new Date().getFullYear()}</span>
            </div>
            <span>By Faramarz Kowsari</span>
          </div>
        </div>
      </footer>
    </div>
  );
}
